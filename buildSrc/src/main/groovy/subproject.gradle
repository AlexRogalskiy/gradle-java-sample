import org.apache.tools.ant.filters.ReplaceTokens
import org.gradle.api.tasks.testing.logging.TestExceptionFormat

//compileJava {
//  doFirst {
//    options.compilerArgs = [
//      '--module-path', classpath.asPath,
//    ]
//    classpath = files()
//  }
//}

//compileKotlin {
//  kotlinOptions {
//    freeCompilerArgs += ["-Xskip-runtime-version-check"]
//    jvmTarget = "1.8"
//  }
//  sourceCompatibility = JavaVersion.VERSION_1_8
//  targetCompatibility = JavaVersion.VERSION_1_8
//}

//compileTestKotlin {
//  kotlinOptions {
//    jvmTarget = "1.8"
//  }
//  sourceCompatibility = JavaVersion.VERSION_1_8
//  targetCompatibility = JavaVersion.VERSION_1_8
//}

//ktlint {
//  version = KTLINT_VERSION
//  filter {
//    exclude { projectDir.toURI().relativize(it.file.toURI()).path.contains("/generated/") }
//  }
//}

configurations.all { config ->
  config.resolutionStrategy {
    cacheChangingModulesFor 0, 'seconds'
    dependencySubstitution {
      if (config.name.toLowerCase().contains('test')) {
        substitute module('org.slf4j:slf4j-simple:1.6.1') with module('org.slf4j:slf4j-nop:1.6.1')
      }
    }
  }
}

tasks.withType(Test) {
  maxParallelForks = Runtime.runtime.availableProcessors()
}

tasks.withType(JavaCompile) {
  configure(options) {
    options.encoding = 'UTF-8'
    options.deprecation = true
    options.compilerArgs += ['--release', '8']
    options.compilerArgs += '-Xlint:deprecation'
    options.compilerArgs += '-Xlint:unchecked'
  }
}

clean.doFirst {
  delete "${projectDir}/docs/apidocs"
}

sourceSets {
  main.java.srcDirs += "src/main/java"
  test.java.srcDirs += "src/test/java"
}

processResources {
  doFirst {
    from 'src/main/resources'
    filter(ReplaceTokens, tokens: [project_version: project.version, project_name: project.name])
  }
}

java {
  modularity.inferModulePath.set(true)
}

test {
  useJUnitPlatform()

  testLogging {
    showExceptions = true
    showStandardStreams = true
    exceptionFormat = TestExceptionFormat.FULL
    events "skipped", "failed", "standardOut", "standardError"
  }

  testlogger {
    theme 'standard-parallel'
    showExceptions true
    showStackTraces true
    showCauses true
    showFullStackTraces true
    showSummary true
    showSimpleNames true
    showStandardStreams true
    showPassedStandardStreams false
    showSkippedStandardStreams false
    showFailedStandardStreams true
  }
}

ext.projectConfig = [
  "group"              : 'io.nullables.api.sample',
  "version"            : '1.0.0-SNAPSHOT',
  "description"        : "Gradle java sample project",
  "sourceCompatibility": JavaVersion.VERSION_1_8,
  "targetCompatibility": JavaVersion.VERSION_1_8,
  "projectBuildDir"    : "${rootProject.buildDir}/${project.name}"
]
